from dataclasses import dataclass
from requests import get
from loguru import logger
from datetime import datetime

import os
import telebot
import time


class HorWBot:
    def __init__(self) -> None:
        self.log_file = 'weather_{time}.log'
        self.API_KEY = os.getenv('W_API_KEY')
        self.API_URL = os.getenv('W_URL')
        self.bot = telebot.TeleBot(os.getenv('TELEGRAM_TOKEN'))
        self.CHAT_ID = os.getenv('CHAT_ID')
        self.time_send = '08:05'
        self.timeout_loop = 0.65
        self.w_data = {}
        self.current_w = {}
        self.hourly_w = {}
        self.do_send = True
        self._work = True


    def save_log_to_file(self, file_path = None) -> None:
        if file_path is None:
            logger.add(self.log_file)
        else:
            logger.add(file_path)


    def save_log_file(self):
        root_dir = os.path.dirname(__file__)
        logs_dir = os.path.join(root_dir, 'logs')
        if not os.path.isdir(logs_dir) :
            os.mkdir(logs_dir)
        file_path_log = os.path.join(logs_dir, self.log_file)
        logger.add(file_path_log)


    def send_message(self, text: str) -> None:
        logger.info(f'ะัะดะฟัะฐะฒะปะตะฝะพ ะฟะพะฒัะดะพะผะปะตะฝะฝั Telgram ะฒ ัะฐั {self.CHAT_ID}')
        self.bot.send_message(self.CHAT_ID, text)


    def get_url_for_api_request(self) -> str:
        params = {
            "exclude": "daily",
            "lat": "49.285",
            "lon": "31.445",
            "units": "metric",
            "appid": self.API_KEY,
            "lang": "ua"
        }
        http_query = "&".join([k+"="+v for k,v in params.items()])
        return f'{self.API_URL}?{http_query}'


    def get_api_data(self):
        try:
            logger.debug(self.get_url_for_api_request())
            req = get(self.get_url_for_api_request())
            if req.status_code != 200:
                logger.error(req)
            self.w_data = req.json()
            logger.info("ะะฐะฝั ะฟัะพ ะฟะพะณะพะดั ะพััะธะผะฐะฝะพ ััะฟััะฝะพ!")
        except:
            logger.error('ะะพะผะธะปะบะฐ ัะฝัะตัะฝะตัั...')


    def get_date(self,format: str, unix_time: int) -> str:
        return datetime.fromtimestamp(unix_time).strftime(format)

    
    def get_weather(self) -> None:
        self.get_api_data()
        if self.w_data.get('current') != None:
            self.current_w = self.w_data.get('current')
        else:
            logger.error("ะะต ะพััะธะผะฐะฝะพ ะฟะพะณะพะปั ะฝะฐ ะฟะพัะพัะฝะธะน ัะฐั.")
        if self.w_data.get('hourly') != None:
            self.hourly_w = self.w_data.get('hourly')
        else:
            logger.error("ะะต ะพััะธะผะฐะฝะพ ะฟัะพะณะฝะพะท ะฟะพะณะพะดะธ.")


    def template(self, item, current = True) -> str:
        if current:
            dt = self.get_date("%d.%m.%Y %H:%M", item['dt'])
        else:
            dt = self.get_date("%H:%M", item['dt'])
        temp = int( item['temp'])
        feels_like = int( item['feels_like'])
        if current:
            sunrise = self.get_date("%H:%M",item['sunrise'])
            sunset = self.get_date("%H:%M", item['sunset'])
        clouds = item['clouds']
        wind_speed = int( item['wind_speed'] )
        wind_deg = self.get_mark_for_wind_angle(item['wind_deg'])
        weather_info = self.get_info_weather(item['weather'][0]['id'])
        weather_title = weather_info['title']
        weather_description = weather_info['description']
        if current:
            t = f"""
ะะฐ ะดะฐะฝะธะน ัะฐั {dt}:
ะขะตะผะฟะตัะฐัััะฐ ๐ก {temp}โ,
ะฒัะดััะฒะฐัััั ัะบ: ๐ก {feels_like}โ.
ะััะตั: ๐ช {wind_deg} {wind_speed}ะผ/ั.
ะกััะด ๐ ะฒ {sunrise}, ะทะฐััะด ๐ ะฒ {sunset}.
{weather_title}

"""
        else: 
            t = f'''ะัะพะณะฝะพะท ะฝะฐ {dt}:
ะขะตะผะฟะตัะฐัััะฐ ๐ก {temp}โ,
ะฒัะดััะฒะฐัััั ัะบ: ๐ก {feels_like}โ.
ะััะตั: ๐ช {wind_deg} {wind_speed}ะผ/ั.
{weather_title}
'''
        return t


    def get_current(self) -> str:
        return self.template(self.current_w)


    def get_today_weather(self) -> list:
        todays = []
        format = '%d'
        today_date = time.strftime(format)
        for h in self.hourly_w:
            if self.get_date(format, h['dt']) == today_date and int(self.get_date('%H', h['dt'])) % 2 == 0:
                todays.append(h)
        
        return todays


    def get_today(self) -> str:
        return "\n".join([ self.template(x, False) for x in self.get_today_weather()] )


    def get_info_weather(self, weather_id:int) -> dict:
        data_trans = [
            {"id": 200, "title": "ะัะพะทะฐ ๐ฉ๐ง", "description": "ะณัะพะทะฐ ะท ะฝะตะฒะตะปะธะบะธะผ ะดะพัะตะผ", "icon": ""},
            {"id": 201, "title": "ะัะพะทะฐ ๐ฉ๐ง๐ง", "description": "ะณัะพะทะฐ ะท ะดะพัะตะผ", "icon": ""},
            {"id": 202, "title": "ะัะพะทะฐ ๐ฉ๐ง๐ง๐ง", "description": "ะณัะพะทะฐ ะท ัะธะปัะฝะธะผ ะดะพัะตะผ", "icon": ""},
            {"id": 210, "title": "ะัะพะทะฐ ๐ฉ", "description": "ะปะตะณะบะฐ ะณัะพะทะฐ", "icon": ""},
            {"id": 211, "title": "ะัะพะทะฐ ๐ฉ๐ฉ", "description": "ะัะพะทะฐ", "icon": ""},
            {"id": 212, "title": "ะัะพะทะฐ ๐ฉ๐ฉ๐ฉ", "description": "ัะธะปัะฝะฐ ะณัะพะทะฐ", "icon": ""},
            {"id": 221, "title": "ะัะพะทะฐ ๐ฉ๐ฉ๐ช", "description": "ะณัะพะทะฐ ะท ะฟะพัะธะฒะฐะผะธ", "icon": ""},
            {"id": 230, "title": "ะัะพะทะฐ ๐ฉ๐ง", "description": "ะณัะพะทะฐ ะท ะดััะฑะฝะธะผ ะดะพัะตะผ", "icon": ""},
            {"id": 231, "title": "ะัะพะทะฐ ๐ฉ๐ง๐ง", "description": "ะณัะพะทะฐ ะท ะดะพะถะดะตะผ", "icon": ""},
            {"id": 232, "title": "ะัะพะทะฐ ๐ฉ๐ง๐ง๐ง", "description": "ะณัะพะทะฐ ะท ัะธะปัะฝะพั ะดะพะถะดะตะผ", "icon": ""},
            {"id": 300, "title": "ะะพัะพัะธัั โ", "description": "ะดััะฑะฝะธะน ะดะพั", "icon": "09d"},
            {"id": 301, "title": "ะะพัะพัะธัั โ", "description": "ะะพัะพัะธัั", "icon": "09d"},
            {"id": 302, "title": "ะะพัะพัะธัั โโ", "description": "ัะธะปัะฝะธะน ะดััะฑะฝะธะน ะดะพั", "icon": "09d"},
            {"id": 310, "title": "ะะพัะพัะธัั โโ", "description": "ะฝะตะฒะตะปะธะบะธะน ะดััะฑะฝะธะน ะดะพั", "icon": "09d"},
            {"id": 311, "title": "ะะพัะพัะธัั โ๐ง", "description": "ะดะพั", "icon": "09d"},
            {"id": 312, "title": "ะะพัะพัะธัั โ๐ง๐ง", "description": "ัะธะปัะฝะธะน ะดะพั", "icon": "09d"},
            {"id": 313, "title": "ะะพัะพัะธัั โ๐ง", "description": "ะดะพั ั ะผััะบะฐ", "icon": "09d"},
            {"id": 314, "title": "ะะพัะพัะธัั โ๐ง๐ง๐ง", "description": "ัะธะปัะฝะธะน ะดะพั ั ะผััะบะฐ", "icon": "09d"},
            {"id": 321, "title": "ะะพัะพัะธัั โ๐ง", "description": "ะดะพัะพะฒะฐ ะผััะบะฐ", "icon": "09d"},
            {"id": 500, "title": "ะะพัะธะบ ๐ง", "description": "ะปะตะณะบะธะน ะดะพั", "icon": "10d"},
            {"id": 501, "title": "ะะพั ะฟะพะธััะฝะธะน ๐ง", "description": "ะฟะพะผััะฝะธะน ะดะพั", "icon": "10d"},
            {"id": 502, "title": "ะะพั ะณะฐัะฝะธะน ๐ง๐ง", "description": "ัะธะปัะฝะธะน ะดะพั", "icon": "10d"},
            {"id": 503, "title": "ะะพั (ัะบ ะท ะฒัะดัะฐ) ๐ง๐ง๐ง", "description": "ะดัะถะต ัะธะปัะฝะธะน ะดะพั", "icon": "10d"},
            {"id": 504, "title": "ะะพัะฐัะฐ (ัะฐ ะฝั ะฝะฐั..) ๐ง๐ง๐ง๐ง", "description": "ะตะบัััะตะผะฐะปัะฝะธะน ะดะพั", "icon": "10d"},
            {"id": 511, "title": "ะะพั ๐งโ", "description": "ัะพะปะพะดะฝะธะน ะดะพั", "icon": "13d"},
            {"id": 520, "title": "ะะพั ๐ง๐ง", "description": "ะฝะตะฒะตะปะธะบะธะน ัะฝัะตะฝัะธะฒะฝะธะน ะดะพั ", "icon": "09d"},
            {"id": 521, "title": "ะะพั ๐ง๐ง", "description": "ะดะพั", "icon": "10d"},
            {"id": 522, "title": "ะะพั ๐ง๐ง๐ง", "description": "ัะธะปัะฝะธะน ะทะปะธะฒะพะฒะธะน ะดะพั", "icon": "10d"},
            {"id": 531, "title": "ะะพั ๐ง", "description": "ะฟะพัะธะฒะธััะธะน ะดะพั", "icon": "10d"},
            {"id": 600, "title": "ะกะฝัะณ ๐จ", "description": "ะฝะตะฒะธะปะธะบะธะน ัะฝัะณ", "icon": "10d"},
            {"id": 601, "title": "ะกะฝัะณ ๐จ", "description": "ัะฝัะณ", "icon": "10d"},
            {"id": 602, "title": "ะกะฝัะณ ๐จ๐จ๐จ", "description": "ัะธะปัะฝะธะน ัะฝัะณ", "icon": "10d"},
            {"id": 611, "title": "ะกะฝัะณ ๐จ๐ง", "description": "ะผะพะบัะธะน ัะฝัะณ", "icon": "10d"},
            {"id": 612, "title": "ะกะฝัะณ ๐จ๐ง", "description": "ะะตะณะบะธะน ะผะพะบัะธะน ัะฝัะณ", "icon": "10d"},
            {"id": 613, "title": "ะกะฝัะณ ๐จ๐จโ", "description": "ะะปะธะฒะพะฒะธะน ัะฝัะณ", "icon": "10d"},
            {"id": 615, "title": "ะกะฝัะณ ๐ง๐จ", "description": "ะะตะฒะตะปะธะบะธะน ะดะพั ั ัะฝัะณ", "icon": "10d"},
            {"id": 616, "title": "ะกะฝัะณ ๐จ๐งโ", "description": "ะะพั ั ัะฝัะณ", "icon": "10d"},
            {"id": 620, "title": "ะกะฝัะณ ๐ง๐จ", "description": "ะะตะฒะตะปะธะบะธะน ะดะพั ัะฝัะณ", "icon": "10d"},
            {"id": 621, "title": "ะกะฝัะณ ๐ง๐จ", "description": "ะะพัะพะฒะธะน ัะฝัะณ", "icon": "10d"},
            {"id": 622, "title": "ะกะฝัะณ ๐ง๐จ๐จ๐จ", "description": "ะกะธะปัะฝะธะน ะทะปะธะฒะพะฒะธะน ัะฝัะณ", "icon": "10d"},
            {"id": 701, "title": "ะขัะผะฐะฝ", "description": "ะขัะผะฐะฝ", "icon": "50d"},
            {"id": 711, "title": "ะะธะผ", "description": "ะะธะผ", "icon": "50d"},
            {"id": 721, "title": "ะะธะผะบะฐ", "description": "ะะธะผะบะฐ", "icon": "50d"},
            {"id": 731, "title": "ะะธะป", "description": "ะะธะป", "icon": "50d"},
            {"id": 741, "title": "ะขัะผะฐะฝ", "description": "ะขัะผะฐะฝ (fog)", "icon": "50d"},
            {"id": 751, "title": "ะััะพะบ", "description": "ะััะพะบ", "icon": "50d"},
            {"id": 761, "title": "ะะธะป", "description": "ะะธะป", "icon": "50d"},
            {"id": 762, "title": "ะะพะปะฐ", "description": "ะฒัะปะบะฐะฝััะฝะธะน ะฟะพะฟัะป", "icon": "50d"},
            {"id": 771, "title": "ะจะบะฒะฐะป", "description": "ะจะบะฒะฐะป", "icon": "50d"},
            {"id": 781, "title": "ะขะพัะฝะฐะดะพ ๐ช", "description": "ะขะพัะฝะฐะดะพ", "icon": "50d"},
            {"id": 800, "title": "๐", "description": "ะงะธััะต ะฝะตะฑะพ", "icon": "50d"},
            {"id": 801, "title": "๐ค", "description": "ะผะฐะปะพ ัะผะฐั: 11-25%", "icon": "50d"},
            {"id": 802, "title": "๐คโ", "description": "ะฝะตะฒะตะปะธะบะฐ ัะผะฐัะฝัััั: 25-50%", "icon": "50d"},
            {"id": 803, "title": "๐คโโ", "description": "ัะพะทะฑะธัะฐ ัะผะฐัะฝัััั: 51-84%", "icon": "50d"},
            {"id": 804, "title": "โโโ", "description": "ัะผะฐัะฝัััั: 85-100%", "icon": "50d"}  
        ]
        for t in data_trans:
            if t['id'] == weather_id:
                return t
        logger.error(f'ะะตะผะฐั ะฟะตัะตะบะปะฐะดั ะดะปั ััะพะณะพ {weather_id}')
        return {"id": 804, "title": "ะะตะฒัะดะพะผะพ", "description": "ะะตะฒัะดะพะผะพ", "icon": "50d"}


    def get_mark_for_wind_angle(self, wind_angle:int) -> str:
        wind_angle = int( wind_angle )
        if wind_angle > 0 and wind_angle < 90:
            return f"ะะฝะกั"
        elif wind_angle > 90 and wind_angle < 180:
            return f"ะะดะกั"
        elif wind_angle > 180 and wind_angle < 240:
            return f"ะะดะั"
        elif wind_angle > 240 and wind_angle < 360:
            return f"ะะฝะั"
        elif wind_angle == 0:
            return "ะะฝ"
        elif wind_angle == 90:
            return "ะกั"
        elif wind_angle == 180:
            return "ะะด"
        elif wind_angle == 240:
            return "ะั"
        else:
            return f"ะฅะ?"


    def send_waather(self) -> None:
        mess = 'ะะพะฑัะพะณะพ ัะฐะฝะบั ๐ ะะพัะพะดะธัะตะฝะฐ, ะฟะพะณะพะดะฐ ะฝะฐ ััะพะณะพะดะฝั ๐: \n'
        mess += self.get_current()
        mess += self.get_today()
        mess += '\n\nะะดะฐะปะพะณะพ ะะฐะผ ะดะฝั โ๏ธโผ๏ธ\n\n#ะฟะพะณะพะดะฐ'
        self.send_message(mess)


    def run(self):
        self._work = True


    def terminate(self):
        self._work = False


    def loop(self):
        logger.info(f'ะะพัะฒัะพะบ ัะพะฑะพัะธ ะฑะพัั ะฟัะพะณะฝะพะทั ะฟะพะณะพะดะธ ะดะปั ะบะฐะฝะฐะปั {self.CHAT_ID}, ัะฟัะฐััะพะฒัั ั {self.time_send}, ะพะฝะพะฒะปััััั ะบะพะถะฝั {self.timeout_loop} ัะตะบัะฝะดะธ.')
        # self.get_weather()
        # self.send_waather()
        m = 0
        try:
            while True:
                if not self._work:
                    logger.info('ะัะดะฟัะฐะฒะปะตะฝะฝั ะฟัะพะณะฝะพะทั ะฒะธะผะบะฝะตะฝะพ')
                    break
                if time.strftime('%H:%M:%S') == self.time_send + ':00':
                    self.get_weather()
                    self.send_waather()
                time.sleep(self.timeout_loop)
        except KeyboardInterrupt:
            logger.info('ะัะพะณัะฐะผั ะทัะฟะธะฝะตะฝะพ.')
        except:
            logger.error('ะะพะผะธะปะบะฐ ะฒ ัะธะบะปั loop!')

        


if __name__ == "__main__":
    bot = HorWBot()
    bot.save_log_to_file()
    bot.loop()

